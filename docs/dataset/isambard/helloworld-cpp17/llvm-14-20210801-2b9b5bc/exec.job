
#!/bin/bash
#PBS -q milanq
#PBS -l select=1:ncpus=128
#PBS -l walltime=00:30:00
#PBS -l place=excl
#PBS -joe

#export CPATH="/usr/lib/gcc/x86_64-redhat-linux/8/include:${CPATH:-}"

# export CPATH="/lustre/projects/bristol/modules/gcc/12.1.0/lib/gcc/x86_64-pc-linux-gnu/12.1.0/include:${CPATH:-}"

_rtb_extra_flags() {
  case "$RTB_CXX" in
  *clang\+\+ | *clang) echo "--gcc-toolchain=/lustre/projects/bristol/modules/gcc/12.1.0" ;;
  *) echo "" ;;
  esac
}



set -eu
TIMEFORMAT='{"realS":%R,"userS":%U,"systemS":%S}'
(

  rm -rf /tmp/rtb/llvm-14-20210801-2b9b5bc
  mkdir -p /tmp/rtb/llvm-14-20210801-2b9b5bc
  cd "/tmp/rtb/llvm-14-20210801-2b9b5bc" || (echo "Cannot enter /tmp/rtb/llvm-14-20210801-2b9b5bc" && exit 1)

  echo "# restore fixture" >"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
  cp -a /lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/fixture/. .  &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"

  echo "# prime" >>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
  {
        
    tar xf /lustre/home/br-wlin/race-to-binary/cache/amd64/llvm/llvm-14-20210801-2b9b5bc.llvm-14.2021-08-01Z.2b9b5bc.tar.xz
    
    root=$(readlink -f opt/*)
    echo "Compiler root:$root"
    
    export PATH="$root/bin:${PATH:-}"
    export CPATH="$root/include:${CPATH:-}"
    export LIBRARY_PATH="$root/lib:${LIBRARY_PATH:-}"
    
    export RTB_CXX="$root/bin/clang++"
    export RTB_CC="$root/bin/clang"
    
    "$RTB_CXX" -v
  } &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"

  if [[ $(type -t _rtb_extra_flags) == function ]]; then
    export RTB_EXTRA_FLAGS=$(_rtb_extra_flags)
  else
    export RTB_EXTRA_FLAGS=""
  fi
  echo "# RTB_CXX        =$RTB_CXX"         &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
  echo "# RTB_CC         =$RTB_CC"          &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
  echo "# RTB_EXTRA_FLAGS=$RTB_EXTRA_FLAGS" &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
  

  source /lustre/home/br-wlin/race-to-binary/input/isambard/helloworld-cpp17.job.sh

  echo "# setup" >>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
  _setup        &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"

  sync

  for i in {1..5}; do
    echo "# run $i" >>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
    (
      (time _test &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt") &>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/time.$i.json"
    )
  done

  echo "# check" >>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"
  _check        &>>"/lustre/home/br-wlin/race-to-binary/dataset-p3-login-20220925/isambard/helloworld-cpp17/llvm-14-20210801-2b9b5bc/log.txt"

  rm -rf /tmp/rtb/llvm-14-20210801-2b9b5bc

)

